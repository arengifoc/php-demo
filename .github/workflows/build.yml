name: Build y Publicaci√≥n de Imagen Docker

on:
  push:
    branches: [ master ]
  workflow_dispatch:  # Permite ejecuci√≥n manual

jobs:
  build-and-push:
    name: Construir y Publicar Imagen
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      image_tag: ${{ steps.meta.outputs.commit_short }}
      timestamp: ${{ steps.meta.outputs.timestamp }}
    defaults:
      run:
        shell: bash
    
    steps:
    - uses: actions/checkout@v4

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, json

    - name: Instalar dependencias de producci√≥n
      run: composer install --prefer-dist --no-progress --no-dev --optimize-autoloader

    - name: Generar tags de imagen
      id: meta
      run: |
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
        echo "timestamp=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
        echo "Tags generados: $COMMIT_SHORT"

    - name: Login en Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Configurar Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Construir imagen Docker (sin publicar)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/php/Dockerfile.prod
        push: false
        load: true
        tags: |
          ${{ vars.DOCKERHUB_USERNAME }}/php-demo:latest
          ${{ vars.DOCKERHUB_USERNAME }}/php-demo:${{ steps.meta.outputs.commit_short }}
          ${{ vars.DOCKERHUB_USERNAME }}/php-demo:${{ steps.meta.outputs.timestamp }}
        build-args: |
          GIT_COMMIT=${{ steps.meta.outputs.commit_short }}
          BUILD_DATE=${{ steps.meta.outputs.timestamp }}
          IMAGE_TAG=${{ steps.meta.outputs.commit_short }}
        cache-from: type=registry,ref=${{ vars.DOCKERHUB_USERNAME }}/php-demo:buildcache
        cache-to: type=registry,ref=${{ vars.DOCKERHUB_USERNAME }}/php-demo:buildcache,mode=max

    - name: Probar imagen productiva
      run: |
        echo "üß™ Probando imagen autocontenida..."
        docker compose -f docker-compose.prod.yml up -d
        
        echo "‚è≥ Esperando a que la aplicaci√≥n inicie..."
        sleep 10
        
        echo "üìã Estado de contenedores:"
        docker compose -f docker-compose.prod.yml ps
        
        echo ""
        echo "üìù Logs de la aplicaci√≥n (Nginx + PHP-FPM):"
        docker compose -f docker-compose.prod.yml logs app
        
        echo ""
        echo "‚úì Probando endpoint ra√≠z..."
        http_code=$(curl -s -o /tmp/response.txt -w "%{http_code}" http://localhost:8080)
        response=$(cat /tmp/response.txt)
        
        echo "HTTP Status Code: $http_code"
        echo "Respuesta:"
        echo "$response"
        
        if [ "$http_code" != "200" ]; then
          echo "‚ùå Error: Se esperaba HTTP 200, pero se recibi√≥ $http_code"
          docker compose -f docker-compose.prod.yml logs
          docker compose -f docker-compose.prod.yml down
          exit 1
        fi
        
        if echo "$response" | grep -qi "fatal error\|warning\|parse error"; then
          echo "‚ùå Error PHP detectado en la respuesta"
          docker compose -f docker-compose.prod.yml down
          exit 1
        fi
        
        echo "‚úÖ Endpoint ra√≠z OK (HTTP 200)"
        
        echo ""
        echo "‚úì Probando endpoint de salud..."
        health_code=$(curl -s -o /tmp/health.txt -w "%{http_code}" http://localhost:8080/health)
        health_response=$(cat /tmp/health.txt)
        
        echo "HTTP Status Code: $health_code"
        echo "Respuesta:"
        echo "$health_response"
        
        if [ "$health_code" != "200" ]; then
          echo "‚ùå Error: Se esperaba HTTP 200, pero se recibi√≥ $health_code"
          docker compose -f docker-compose.prod.yml logs
          docker compose -f docker-compose.prod.yml down
          exit 1
        fi
        
        if echo "$health_response" | grep -qi "fatal error\|warning\|parse error"; then
          echo "‚ùå Error PHP detectado en la respuesta"
          docker compose -f docker-compose.prod.yml down
          exit 1
        fi
        
        echo "‚úÖ Endpoint de salud OK (HTTP 200)"
        
        echo ""
        echo "‚úÖ Imagen productiva funciona correctamente"
        docker compose -f docker-compose.prod.yml down

    - name: Publicar imagen a Docker Hub
      run: |
        echo "üì§ Publicando imagen a Docker Hub..."
        docker push ${{ vars.DOCKERHUB_USERNAME }}/php-demo:latest
        docker push ${{ vars.DOCKERHUB_USERNAME }}/php-demo:${{ steps.meta.outputs.commit_short }}
        docker push ${{ vars.DOCKERHUB_USERNAME }}/php-demo:${{ steps.meta.outputs.timestamp }}
        echo "‚úÖ Imagen publicada exitosamente"

    - name: Resumen de imagen publicada
      run: |
        echo "## üê≥ Imagen Docker Publicada" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Imagen construida y publicada exitosamente" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Tags generados:" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ vars.DOCKERHUB_USERNAME }}/php-demo:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ vars.DOCKERHUB_USERNAME }}/php-demo:${{ steps.meta.outputs.commit_short }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ vars.DOCKERHUB_USERNAME }}/php-demo:${{ steps.meta.outputs.timestamp }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### C√≥mo usar:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ vars.DOCKERHUB_USERNAME }}/php-demo:${{ steps.meta.outputs.commit_short }}" >> $GITHUB_STEP_SUMMARY
        echo "docker run -p 8080:8080 ${{ vars.DOCKERHUB_USERNAME }}/php-demo:${{ steps.meta.outputs.commit_short }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Verificar imagen en Docker Hub
      run: |
        echo "Imagen disponible en: https://hub.docker.com/r/${{ vars.DOCKERHUB_USERNAME }}/php-demo"

  # Job de despliegue autom√°tico a DEV
  deploy-dev:
    name: Deploy a DEV
    needs: build-and-push
    uses: ./.github/workflows/deploy-dev.yml
    with:
      image_tag: ${{ needs.build-and-push.outputs.image_tag }}
    secrets: inherit
