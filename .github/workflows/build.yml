name: Build y PublicaciÃ³n de Imagen Docker

on:
  push:
    branches: [ master ]
  workflow_dispatch:  # Permite ejecuciÃ³n manual

jobs:
  build-and-push:
    name: Construir y Publicar Imagen
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        shell: bash
    
    steps:
    - uses: actions/checkout@v4

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, json

    - name: Instalar dependencias de producciÃ³n
      run: composer install --prefer-dist --no-progress --no-dev --optimize-autoloader

    - name: Generar tags de imagen
      id: meta
      run: |
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
        echo "timestamp=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
        echo "Tags generados: $COMMIT_SHORT"

    - name: Login en Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Configurar Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Construir imagen Docker (sin publicar)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/php/Dockerfile.prod
        push: false
        load: true
        tags: |
          ${{ vars.DOCKERHUB_USERNAME }}/php-demo:latest
          ${{ vars.DOCKERHUB_USERNAME }}/php-demo:${{ steps.meta.outputs.commit_short }}
          ${{ vars.DOCKERHUB_USERNAME }}/php-demo:${{ steps.meta.outputs.timestamp }}
        cache-from: type=registry,ref=${{ vars.DOCKERHUB_USERNAME }}/php-demo:buildcache
        cache-to: type=registry,ref=${{ vars.DOCKERHUB_USERNAME }}/php-demo:buildcache,mode=max

    - name: Probar imagen productiva
      run: |
        echo "ðŸ§ª Probando imagen autocontenida..."
        docker compose -f docker-compose.prod.yml up -d
        
        echo "â³ Esperando a que la aplicaciÃ³n inicie..."
        sleep 10
        
        echo "ðŸ“‹ Estado de contenedores:"
        docker compose -f docker-compose.prod.yml ps
        
        echo ""
        echo "ðŸ“ Logs de la aplicaciÃ³n (Nginx + PHP-FPM):"
        docker compose -f docker-compose.prod.yml logs app
        
        echo ""
        echo "âœ“ Probando endpoint raÃ­z..."
        http_code=$(curl -s -o /tmp/response.txt -w "%{http_code}" http://localhost:8080)
        response=$(cat /tmp/response.txt)
        
        echo "HTTP Status Code: $http_code"
        echo "Respuesta:"
        echo "$response"
        
        if [ "$http_code" != "200" ]; then
          echo "âŒ Error: Se esperaba HTTP 200, pero se recibiÃ³ $http_code"
          docker compose -f docker-compose.prod.yml logs
          docker compose -f docker-compose.prod.yml down
          exit 1
        fi
        
        if echo "$response" | grep -qi "fatal error\|warning\|parse error"; then
          echo "âŒ Error PHP detectado en la respuesta"
          docker compose -f docker-compose.prod.yml down
          exit 1
        fi
        
        echo "âœ… Endpoint raÃ­z OK (HTTP 200)"
        
        echo ""
        echo "âœ“ Probando endpoint de salud..."
        health_code=$(curl -s -o /tmp/health.txt -w "%{http_code}" http://localhost:8080/health)
        health_response=$(cat /tmp/health.txt)
        
        echo "HTTP Status Code: $health_code"
        echo "Respuesta:"
        echo "$health_response"
        
        if [ "$health_code" != "200" ]; then
          echo "âŒ Error: Se esperaba HTTP 200, pero se recibiÃ³ $health_code"
          docker compose -f docker-compose.prod.yml logs
          docker compose -f docker-compose.prod.yml down
          exit 1
        fi
        
        if echo "$health_response" | grep -qi "fatal error\|warning\|parse error"; then
          echo "âŒ Error PHP detectado en la respuesta"
          docker compose -f docker-compose.prod.yml down
          exit 1
        fi
        
        echo "âœ… Endpoint de salud OK (HTTP 200)"
        
        echo ""
        echo "âœ… Imagen productiva funciona correctamente"
        docker compose -f docker-compose.prod.yml down

    - name: Publicar imagen a Docker Hub
      run: |
        echo "ðŸ“¤ Publicando imagen a Docker Hub..."
        docker push ${{ vars.DOCKERHUB_USERNAME }}/php-demo:latest
        docker push ${{ vars.DOCKERHUB_USERNAME }}/php-demo:${{ steps.meta.outputs.commit_short }}
        docker push ${{ vars.DOCKERHUB_USERNAME }}/php-demo:${{ steps.meta.outputs.timestamp }}
        echo "âœ… Imagen publicada exitosamente"

    - name: Resumen de imagen publicada
      run: |
        echo "## ðŸ³ Imagen Docker Publicada" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Imagen construida y publicada exitosamente" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Tags generados:" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ vars.DOCKERHUB_USERNAME }}/php-demo:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ vars.DOCKERHUB_USERNAME }}/php-demo:${{ steps.meta.outputs.commit_short }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ vars.DOCKERHUB_USERNAME }}/php-demo:${{ steps.meta.outputs.timestamp }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### CÃ³mo usar:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ vars.DOCKERHUB_USERNAME }}/php-demo:${{ steps.meta.outputs.commit_short }}" >> $GITHUB_STEP_SUMMARY
        echo "docker run -p 8080:8080 ${{ vars.DOCKERHUB_USERNAME }}/php-demo:${{ steps.meta.outputs.commit_short }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Verificar imagen en Docker Hub
      run: |
        echo "Imagen disponible en: https://hub.docker.com/r/${{ vars.DOCKERHUB_USERNAME }}/php-demo"
