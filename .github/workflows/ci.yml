name: Integraci√≥n Continua

on:
  pull_request:
    branches: [master]
  push:
    branches-ignore: [master]

jobs:
  # ‚úÖ Validaci√≥n de c√≥digo
  validacion:
    name: Validaci√≥n de C√≥digo
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, xml, ctype, json

      - name: Cachear dependencias
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: Validar composer.json
        run: composer validate --strict

      - name: Verificar estilo de c√≥digo (PHP-CS-Fixer)
        run: composer cs:check

  # üîç An√°lisis est√°tico
  analisis-estatico:
    name: An√°lisis Est√°tico (PHPStan)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, xml, ctype, json

      - name: Cachear dependencias
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: Ejecutar PHPStan (Nivel 8)
        run: composer phpstan

  # üß™ Tests Unitarios
  tests-unitarios:
    name: Tests Unitarios
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, xml, ctype, json
          coverage: xdebug

      - name: Cachear dependencias
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: Ejecutar tests unitarios
        run: vendor/bin/phpunit tests/Handler/HealthHandlerTest.php --testdox

  # üîó Tests de Integraci√≥n
  tests-integracion:
    name: Tests de Integraci√≥n
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, xml, ctype, json
          coverage: xdebug

      - name: Cachear dependencias
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: Ejecutar tests de integraci√≥n
        run: vendor/bin/phpunit tests/Handler/HealthHandlerIntegrationTest.php --testdox

  # üß© Tests de Aplicaci√≥n
  tests-aplicacion:
    name: Tests de Aplicaci√≥n (E2E)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, xml, ctype, json
          coverage: xdebug

      - name: Cachear dependencias
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: Ejecutar tests de aplicaci√≥n completa
        run: vendor/bin/phpunit tests/ApplicationTest.php --testdox

  # üìä Cobertura de C√≥digo
  cobertura:
    name: Cobertura de C√≥digo
    runs-on: ubuntu-latest
    needs: [tests-unitarios, tests-integracion, tests-aplicacion]
    permissions:
      contents: write
      pull-requests: write
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, xml, ctype, json
          coverage: xdebug

      - name: Cachear dependencias
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Instalar dependencias
        run: composer install --prefer-dist --no-progress

      - name: Generar reporte de cobertura completo
        run: |
          vendor/bin/phpunit --coverage-clover=coverage.xml --coverage-html=coverage --coverage-text | tee coverage-output.txt

      - name: Extraer resumen de cobertura
        id: coverage
        run: |
          # Extraer el porcentaje de cobertura del reporte de PHPUnit
          COVERAGE=$(grep -oP 'Lines:\s+\K[\d.]+(?=%)' coverage-output.txt | head -1)
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Cobertura de l√≠neas: $COVERAGE%"

      - name: Crear resumen de cobertura
        run: |
          echo "## üìä Reporte de Cobertura de C√≥digo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cobertura Total: ${{ steps.coverage.outputs.percentage }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìÑ [Ver reporte completo en artefactos](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Agregar detalles del reporte de texto
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Ver detalles de cobertura por archivo</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -A 100 "Code Coverage Report:" coverage-output.txt | head -50 >> $GITHUB_STEP_SUMMARY || echo "No se pudo extraer el detalle" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Comentar cobertura en PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.percentage }}';
            const emoji = coverage >= 80 ? '‚úÖ' : coverage >= 60 ? '‚ö†Ô∏è' : '‚ùå';
            const status = coverage >= 80 ? 'Excelente' : coverage >= 60 ? 'Aceptable' : 'Necesita mejora';

            const comment = `## ${emoji} Reporte de Cobertura de C√≥digo

            **Cobertura Total:** ${coverage}% (${status})

            | M√©trica | Valor |
            |---------|-------|
            | Cobertura de l√≠neas | ${coverage}% |
            | Estado | ${status} |

            üìä [Ver reporte completo en artefactos](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Subir cobertura a Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Subir reportes de cobertura como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: reporte-cobertura
          path: coverage/
          retention-days: 30

  # üê≥ Tests Docker
  docker:
    name: Tests Docker (Health Check)
    runs-on: ubuntu-latest
    needs:
      [
        validacion,
        analisis-estatico,
        tests-unitarios,
        tests-integracion,
        tests-aplicacion,
      ]
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, xml, ctype, json

      - name: Instalar dependencias de Composer
        run: composer install --prefer-dist --no-progress --no-dev --optimize-autoloader

      - name: Construir imagen Docker
        run: docker compose build

      - name: Iniciar contenedores
        run: docker compose up -d

      - name: Esperar a que la aplicaci√≥n inicie
        run: sleep 10

      - name: Probar endpoint ra√≠z
        run: |
          response=$(curl -sf http://localhost:8080)
          if echo "$response" | grep -qi "fatal error\|warning\|error"; then
            echo "Error detectado en la respuesta:"
            echo "$response"
            exit 1
          fi
          echo "‚úì Endpoint ra√≠z OK"

      - name: Probar endpoint de salud
        run: |
          response=$(curl -sf http://localhost:8080/health)
          if echo "$response" | grep -qi "fatal error\|warning\|error"; then
            echo "Error detectado en la respuesta:"
            echo "$response"
            exit 1
          fi
          echo "‚úì Endpoint de salud OK"

      - name: Detener contenedores
        if: always()
        run: docker compose down
