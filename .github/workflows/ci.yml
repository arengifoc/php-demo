name: Integraci√≥n Continua

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  # ‚úÖ Validaci√≥n de c√≥digo
  validacion:
    name: Validaci√≥n de C√≥digo
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, json

    - name: Cachear dependencias
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Instalar dependencias
      run: composer install --prefer-dist --no-progress

    - name: Validar composer.json
      run: composer validate --strict

    - name: Verificar estilo de c√≥digo (PHP-CS-Fixer)
      run: composer cs:check

  # üîç An√°lisis est√°tico
  analisis-estatico:
    name: An√°lisis Est√°tico (PHPStan)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, json

    - name: Cachear dependencias
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Instalar dependencias
      run: composer install --prefer-dist --no-progress

    - name: Ejecutar PHPStan (Nivel 8)
      run: composer phpstan

  # üß™ Tests Unitarios
  tests-unitarios:
    name: Tests Unitarios
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, json
        coverage: xdebug

    - name: Cachear dependencias
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Instalar dependencias
      run: composer install --prefer-dist --no-progress

    - name: Ejecutar tests unitarios
      run: vendor/bin/phpunit tests/Handler/HealthHandlerTest.php --testdox

  # üîó Tests de Integraci√≥n
  tests-integracion:
    name: Tests de Integraci√≥n
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, json
        coverage: xdebug

    - name: Cachear dependencias
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Instalar dependencias
      run: composer install --prefer-dist --no-progress

    - name: Ejecutar tests de integraci√≥n
      run: vendor/bin/phpunit tests/Handler/HealthHandlerIntegrationTest.php --testdox

  # üß© Tests de Aplicaci√≥n
  tests-aplicacion:
    name: Tests de Aplicaci√≥n (E2E)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, json
        coverage: xdebug

    - name: Cachear dependencias
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Instalar dependencias
      run: composer install --prefer-dist --no-progress

    - name: Ejecutar tests de aplicaci√≥n completa
      run: vendor/bin/phpunit tests/ApplicationTest.php --testdox

  # üìä Cobertura de C√≥digo
  cobertura:
    name: Cobertura de C√≥digo
    runs-on: ubuntu-latest
    needs: [tests-unitarios, tests-integracion, tests-aplicacion]

    steps:
    - uses: actions/checkout@v4

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, json
        coverage: xdebug

    - name: Cachear dependencias
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Instalar dependencias
      run: composer install --prefer-dist --no-progress

    - name: Generar reporte de cobertura completo
      run: vendor/bin/phpunit --coverage-clover=coverage.xml --coverage-html=coverage --coverage-text

    - name: Subir cobertura a Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.xml
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Subir reportes de cobertura como artefacto
      uses: actions/upload-artifact@v4
      with:
        name: reporte-cobertura
        path: coverage/
        retention-days: 30

    - name: Comentar cobertura en PR
      if: github.event_name == 'pull_request'
      uses: py-cov-action/python-coverage-comment-action@v3
      with:
        GITHUB_TOKEN: ${{ github.token }}
        MINIMUM_GREEN: 80
        MINIMUM_ORANGE: 60

  # üê≥ Tests Docker
  docker:
    name: Tests Docker (Health Check)
    runs-on: ubuntu-latest
    needs: [validacion, analisis-estatico, tests-unitarios, tests-integracion, tests-aplicacion]

    steps:
    - uses: actions/checkout@v4

    - name: Construir imagen Docker
      run: docker-compose build

    - name: Iniciar contenedores
      run: docker-compose up -d

    - name: Esperar a que la aplicaci√≥n inicie
      run: sleep 10

    - name: Probar endpoint ra√≠z
      run: |
        curl -f http://localhost:8080 || exit 1

    - name: Probar endpoint de salud
      run: |
        curl -f http://localhost:8080/health || exit 1

    - name: Detener contenedores
      run: docker-compose down
